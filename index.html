<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <title>Smart Master Timetable</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
  #loginSection {
    display: block;
    text-align: center;
    margin: auto;
    margin-top: 50px;
    width: 300px;
    padding: 20px;
    border: 2px solid #2196F3;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    background-color: #4CAF50; /* Green */
}

    #loginSection input[type="text"],
    #loginSection input[type="password"] {
        width: calc(100% - 20px);
        padding: 8px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    #loginSection button {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    input, select, button {
      margin: 5px;
      padding: 5px;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .box {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .timetable-wrapper {
      width: 100%;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .hidden { display: none; }

 footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background-color: #333;
  color: white;
  text-align: center;
  padding: 10px 0;
  font-size: 16px;
  overflow: hidden;
}

.footer-text {
  display: inline-block;
  white-space: nowrap;
  animation: marquee 30s linear infinite;
}

@keyframes marquee {
  0% {
    transform: translateX(100%);
  }
  100% {
    transform: translateX(-100%);
  }
}
 
  </style>
</head>
<body>
<!-- Login Section -->
<div id="login-page" style="text-align: center; padding: 50px; background-color: #a5d6a7; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); max-width: 300px; margin: 50px auto; border: 3px solid #4caf50;">
  <div class="logo">
    <img src=" https://i.imgur.com/55WxXPp.png " alt="School Logo" class="logo-img" style="width: 250px; margin-bottom: 20px;">
  </div>
  
  <h1 style="color: #0056b3; font-size: 28px; font-weight: bold;">RASM School Timetable Generator</h1>
  
  <label for="username" style="font-size: 18px; color: #333;">Username:</label>
  <input type="text" id="username" placeholder="Enter Username" style="padding: 10px; font-size: 16px; margin: 10px 0; width: 80%; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box;">
  
  <label for="password" style="font-size: 18px; color: #333;">Password:</label>
  <input type="password" id="password" placeholder="Enter Password" style="padding: 10px; font-size: 16px; margin: 10px 0; width: 80%; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box;">
  
  <button class="btn btn-register" onclick="login()" style="background-color: #4caf50; color: white; padding: 12px 20px; border-radius: 5px; border: none; font-size: 16px; cursor: pointer; width: 80%; margin-top: 20px;">
    Login
  </button>
  
  <p id="login-error" style="color: red; font-size: 14px; display: none;">Incorrect username or password. Please try again.</p>
</div>

<!-- Main Content after Login -->
<div id="single-view" style="display: none;">
  <!-- School Name and Logout Button -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: #2c3e50; display: flex; align-items: center;">
      <img src="https://i.imgur.com/55WxXPp.png " alt="School Logo" style="height: 150px; margin-right: 12px;">
      NACHU JUNIOR SCHOOL 
    </h2>
    <button onclick="logout()" style="background-color: #f44336; color: white; padding: 10px 20px; border-radius: 8px; font-size: 16px; border: none; cursor: pointer;">
      <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i> Logout
    </button>
  </div>




  <!-- Toggle Control Button -->
  <div style="margin-bottom: 20px;">
    <button onclick="toggleButtonGroup()" style="background-color: #6A1B9A; color: white; padding: 10px 20px; border-radius: 8px; font-size: 16px; border: none; cursor: pointer;">
      <i class="fas fa-tools" style="margin-right: 8px;"></i>
      Show Controls
    </button>
  </div>

  <!-- Button Group: Hidden by default -->
  <div id="button-group" style="display: none; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
    <button onclick="toggleView('single')" style="background-color: #4CAF50; color: white;">
      <i class="fas fa-columns"></i> Single-Page Mode
    </button>

    <button onclick="toggleView('wizard')" style="background-color: #2196F3; color: white;">
      <i class="fas fa-magic"></i> Wizard Mode
    </button>

    <button onclick="generateCombinedTimetable()" class="btn btn-primary" style="background-color: #007bff; color: white;">
      <i class="fas fa-calendar-check"></i> Generate Master Timetable
    </button>
  </div>

  <!-- The rest of your #single-view content continues here -->


<!-- Register Teacher Toggle -->
<div style="margin-bottom: 20px;">
  <button onclick="toggleRegisterForm()" style="background-color: #6A1B9A; color: white; padding: 10px 20px; border-radius: 8px; font-size: 16px; border: none; cursor: pointer;">
    <i class="fas fa-user-plus" style="margin-right: 8px;"></i>
    Register Teacher
  </button>
</div>

<!-- Hidden Register Form -->
<div id="register-teacher-box" class="box" style="display: none;">
  <h2 style="
    background-color: #e9f5ff;
    color: #0056b3;
    padding: 10px 20px;
    border-left: 6px solid #0056b3;
    border-radius: 6px;
    font-size: 22px;
    margin-top: 30px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  ">
    Register Teacher
  </h2>

  <input id="teacher-name" placeholder="Teacher Name">
  <input id="teacher-id" placeholder="Teacher Number" type="number">
  <button onclick="registerTeacher()" style="background-color: #4caf50; color: white;">
    <i class="fas fa-user-plus"></i> Register
  </button>

  <ul id="teacher-list"></ul>
</div>

  

       <div class="box">
    <h2 style="
  background-color: #e6f9ec;
  color: #2e7d32;
  padding: 10px 20px;
  border-left: 6px solid #2e7d32;
  border-radius: 6px;
  font-size: 22px;
  margin-top: 30px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
">
  Assign Subjects to Teachers (Per Grade)
</h2>

      <select id="assign-grade">
        <option disabled selected>Select Grade</option>
 
        <option value="7">Grade 7</option>
        <option value="7A">Grade 7A</option>
        <option value="7B">Grade 7B</option>
        <option value="7C">Grade 7C</option>
        <option value="8">Grade 8</option>
        <option value="8A">Grade 8A</option>
        <option value="8B">Grade 8B</option>
        <option value="8C">Grade 8C</option>
        <option value="9">Grade 9</option>
        <option value="9A">Grade 9A</option>
        <option value="9B">Grade 9B</option>
        <option value="9C">Grade 9C</option>
      </select>
      <div id="subject-assignment"></div>
  <button onclick="saveAssignments()" style="background-color: #ff9800; color: white;">
  <i class="fas fa-save"></i> Save Assignments
</button>
<!-- Toggle Button -->
<button onclick="toggleGradeSelector()" style="background-color: #007bff; color: white; border: none; padding: 10px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
  <i class="fas fa-sliders-h" style="margin-right: 8px;"></i>
  Select Grades
</button>

<!-- Grade Selector Form -->
<div id="grade-container" style="display: none; border: 1px solid #ccc; padding: 15px; border-radius: 10px; background-color: #f2f2f2; width: 300px; margin: 0 auto;">
  <h2 style="color: #2e7d32; text-align: center;">Select Grades to Generate Timetable</h2>

  <form id="grade-selector" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">

    <label><input type="checkbox" name="grade" value="7"> Grade 7</label>
    <label><input type="checkbox" name="grade" value="7A"> Grade 7A</label>
    <label><input type="checkbox" name="grade" value="7B"> Grade 7B</label>
    <label><input type="checkbox" name="grade" value="7C"> Grade 7C</label>
    <label><input type="checkbox" name="grade" value="8"> Grade 8</label>
    <label><input type="checkbox" name="grade" value="8A"> Grade 8A</label>
    <label><input type="checkbox" name="grade" value="8B"> Grade 8B</label>
    <label><input type="checkbox" name="grade" value="8C"> Grade 8C</label>
    <label><input type="checkbox" name="grade" value="9"> Grade 9</label>
    <label><input type="checkbox" name="grade" value="9A"> Grade 9A</label>
    <label><input type="checkbox" name="grade" value="9B"> Grade 9B</label>
    <label><input type="checkbox" name="grade" value="9C"> Grade 9C</label>
  </form>
</div>

 <button onclick="generateCombinedTimetable()" class="btn btn-primary" style="background-color: #007bff; color: white;">
      <i class="fas fa-calendar-check"></i> Generate Master Timetable
    </button>
    <div class="grid" id="master-timetable"></div>
    <div>


  <div id="wizard-view" class="hidden">
    <div class="box" id="wizard-step1">
     <h2 style="background-color: lightgreen; color: black; padding: 8px 12px; border-radius: 4px;">Step 1: Register Teachers</h2>

      <input id="wiz-teacher-name" placeholder="Teacher Name">
      <input id="wiz-teacher-id" placeholder="Teacher Number" type="number">
  <button onclick="registerTeacher(true)" style="background-color: #4caf50; color: white;">
  <i class="fas fa-user-plus"></i> Register
</button>   
<ul id="wiz-teacher-list"></ul>
      <button onclick="nextWizardStep(2)" style="background-color: #007bff; color: white;">
  <i class="fas fa-arrow-right"></i> Next
</button>
    </div>
      <div class="box">
<h2 style="background-color: lightgreen; color: black; padding: 8px 12px; border-radius: 4px;">Step 2:Assign Subjects to Teachers  </h2>
       <select id="assign-grade">
        <option disabled selected>Select Grade</option>
     
        <option value="7">Grade 7</option>
        <option value="7A">Grade 7A</option>
        <option value="7B">Grade 7B</option>
        <option value="7C">Grade 7C</option>
        <option value="8">Grade 8</option>
        <option value="8A">Grade 8A</option>
        <option value="8B">Grade 8B</option>
        <option value="8C">Grade 8C</option>
        <option value="9">Grade 9</option>
        <option value="9A">Grade 9A</option>
        <option value="9B">Grade 9B</option>
        <option value="9C">Grade 9C</option>
      </select>
      <div id="subject-assignment"></div>
  <button onclick="saveAssignments()" style="background-color: #ff9800; color: white;">
  <i class="fas fa-save"></i> Save Assignments
</button>

    </div>
    <div class="box hidden" id="wizard-step3">
    <h2 style="background-color: teal; color: white; padding: 5px;">Step 3: Select Grades</h2>

      <form id="wiz-grade-selector"></form>
    <button onclick="generateMasterTimetable()">Generate Timetable</button>
     
</div>

    <div class="grid" id="wiz-master-timetable"></div>
   
<button onclick="printTimetable(true)" style="background-color: #ff5722; color: white;">
  <i class="fas fa-print"></i> Print Timetable
</button>
 </div>
<div class="box">

</div>
<div id="combined-timetable" class="mt-6"></div>
<button onclick="printCombinedTimetable()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 print:hidden">
  <i class="fas fa-print"></i> Print Timetable
</button>
<div class="no-print" id="term-combined-title" style="margin-bottom: 10px;">
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 14px;">
  <span><strong>Term:</strong> Select term to show on printed timetable</span>
  <select id="term-selector" style="padding: 6px; font-size: 14px; border-radius: 4px;">
    <option value="Term 1">Term 1</option>
    <option value="Term 2">Term 2</option>
    <option value="Term 3">Term 3</option>
  </select>
</div>


<button onclick="extractFromCombinedTimetable()" style="background-color: #6A1B9A; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 20px;">
  <i class="fas fa-code-branch"></i> Extract Class & Teacher Timetables
</button>

<div id="extracted-timetables" style="margin-top: 40px;"></div>
<div style="margin-top: 30px;">

</div>

<!-- Add this modal HTML to your page -->
<div id="customConfirm" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000;">
  <p id="confirmMessage"></p>
  <button id="confirmYes" style="color: white; background: green; border: none; padding: 10px;">Yes</button>
  <button id="confirmNo" style="color: white; background: red; border: none; padding: 10px;">No</button>
</div>
<footer>
  <div class="footer-text">
 Streamline Your School With RASM Tech!
Generate accurate class timetables per stream and get automatic teacher timetables in seconds  all aligned with Ministry of Education guidelines. Say goodbye to manual scheduling and hello to smart, efficient school management. Powered by RASM Technologies.

 2025 Nachu junior school  | All rights reserved. | Powered by RASM Technologies
  </div>
</footer>
</body>


  <script>
   let teachers = [];
const assignments = {};
const subjects = {
  daily: ['English', 'Maths', 'Creative Arts & Sports', 'Integrated Science'],
  fourPerWeek: ['Kiswahili', 'CRE', 'Social Studies', 'Pre-Technical', 'Agriculture']
};
const periods = ['8:00-8:40', '8:40-9:20', 'Break', '9:50-10:30', '10:30-11:10', 'Break', '11:35-12:15', '12:15-12:55', 'Lunch', '2:00-2:40', '2:40-3:00', 'Games'];
const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
const lessonSlots = [0,1,3,4,6,7,9,10];
let teacherSchedule = {};

// Extract unique grades from the teachers list
function getUniqueGrades() {
  return [...new Set(teachers.map(t => t.grade))];
}

function toggleView(mode) {
  document.getElementById('single-view').classList.toggle('hidden', mode !== 'single');
  document.getElementById('wizard-view').classList.toggle('hidden', mode !== 'wizard');
}
// ?? Function to register a teacher and persist
function registerTeacher(wizard = false) {
  const name = document.getElementById(wizard ? 'wiz-teacher-name' : 'teacher-name').value;
  const id = document.getElementById(wizard ? 'wiz-teacher-id' : 'teacher-id').value;

  if (!name || !id) {
    showCustomAlert('Please fill in both fields.', 'red'); // Red alert for missing fields
    return;
  }

  const newTeacher = { name, id };
  teachers.push(newTeacher);

  // Save to localStorage
  localStorage.setItem('teachers', JSON.stringify(teachers));

  // Update both views
  updateTeacherLists();

  // Clear inputs
  document.getElementById(wizard ? 'wiz-teacher-name' : 'teacher-name').value = '';
  document.getElementById(wizard ? 'wiz-teacher-id' : 'teacher-id').value = '';

  showCustomAlert('Teacher successfully registered!', 'green'); // Green alert for success
}
function showCustomAlert(message, color) {
  const alertBox = document.createElement('div');
  alertBox.className = 'custom-alert';
  
  // Style the alert box
  alertBox.style.position = 'fixed';
  alertBox.style.top = '50%';
  alertBox.style.left = '50%';
  alertBox.style.transform = 'translate(-50%, -50%)';
  alertBox.style.backgroundColor = color;
  alertBox.style.color = 'white';
  alertBox.style.padding = '15px 30px';
  alertBox.style.margin = '10px 0';
  alertBox.style.borderRadius = '5px';
  alertBox.style.textAlign = 'center';
  alertBox.style.zIndex = '9999'; // Ensures it is on top of other elements
  alertBox.style.fontSize = '16px';
  alertBox.style.boxShadow = '0px 4px 8px rgba(0, 0, 0, 0.2)'; // Optional shadow for better visibility
  alertBox.innerText = message;

  // Add the alert to the body
  document.body.appendChild(alertBox);

  // Automatically remove the alert after 3 seconds
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}


// ?? Function to render teacher list in both main and wizard sections
function updateTeacherLists() {
  const teacherList = document.getElementById('teacher-list');
  const wizTeacherList = document.getElementById('wiz-teacher-list');
  teacherList.innerHTML = '';
  wizTeacherList.innerHTML = '';
  teachers.forEach(t => {
    const item = `<li>${t.name} (T${t.id})</li>`;
    teacherList.innerHTML += item;
    wizTeacherList.innerHTML += item;
  });
}

// ?? Load teachers from localStorage on page load
window.onload = function () {
  const saved = localStorage.getItem('teachers');
  if (saved) {
    teachers = JSON.parse(saved);
    updateTeacherLists();
  }
};

    document.getElementById('assign-grade').addEventListener('change', e => createAssignDropdown(e.target.value, false));
    document.getElementById('wiz-assign-grade').addEventListener('change', e => createAssignDropdown(e.target.value, true));

function createAssignDropdown(grade, wizard = false) {
  const div = document.getElementById(wizard ? 'wiz-subject-assignment' : 'subject-assignment');
  div.innerHTML = '';

  [...subjects.daily, ...subjects.fourPerWeek].forEach(subj => {
    const sel = document.createElement('select');
    sel.id = `${wizard ? 'wiz-' : ''}g${grade}-${subj}`;
    sel.style.margin = '5px 0';
    sel.style.padding = '6px';
    sel.style.width = '100%';
    sel.style.borderRadius = '4px';
    sel.style.border = '1px solid #ccc';
    sel.style.backgroundColor = '#fefefe';

    // First option now includes the subject name
    sel.innerHTML = `<option value="" disabled selected>Select teacher for ${subj}</option>` +
      teachers.map(t =>
        `<option value="${t.id}">${subj} - ${t.name} (T${t.id})</option>`
      ).join('');

    div.appendChild(sel);
  });
}

 function saveAssignments(wizard = false) {
  const grade = document.getElementById(wizard ? 'wiz-assign-grade' : 'assign-grade').value;

  if (!grade) {
    showCustomAlert('Please select a grade.', 'red');  // Red alert for missing grade selection
    return;
  }

  if (!assignments[grade]) assignments[grade] = {};

  // Ensure the Save button stays visible
  const saveButton = document.querySelector('button[onclick="saveAssignments()"]');
  saveButton.style.display = 'inline-block';  // Ensure it's visible

  [...subjects.daily, ...subjects.fourPerWeek].forEach(subj => {
    const teacherId = document.getElementById(`${wizard ? 'wiz-' : ''}g${grade}-${subj}`)?.value;
    if (teacherId) assignments[grade][subj] = teacherId;
  });

  showCustomAlert(`Assignments for Grade ${grade} saved.`, 'green');  // Green alert for success
}
function showCustomAlert(message, color) {
  const alertBox = document.createElement('div');
  alertBox.className = 'custom-alert';
  
  // Style the alert box
  alertBox.style.position = 'fixed';
  alertBox.style.top = '50%';
  alertBox.style.left = '50%';
  alertBox.style.transform = 'translate(-50%, -50%)';
  alertBox.style.backgroundColor = color;
  alertBox.style.color = 'white';
  alertBox.style.padding = '15px 30px';
  alertBox.style.margin = '10px 0';
  alertBox.style.borderRadius = '5px';
  alertBox.style.textAlign = 'center';
  alertBox.style.zIndex = '9999'; // Ensures it is on top of other elements
  alertBox.style.fontSize = '16px';
  alertBox.style.boxShadow = '0px 4px 8px rgba(0, 0, 0, 0.2)'; // Optional shadow for better visibility
  alertBox.innerText = message;

  // Add the alert to the body
  document.body.appendChild(alertBox);

  // Automatically remove the alert after 3 seconds
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}


    document.getElementById('grade-selector').innerHTML = Array.from({length: 9}, (_, i) => `<label><input type="checkbox" name="grade" value="${i+1}"> Grade ${i+1}</label><br>`).join('');
    document.getElementById('wiz-grade-selector').innerHTML = document.getElementById('grade-selector').innerHTML;

    function isFree(tid, day, period) {
      return !(teacherSchedule[tid] && teacherSchedule[tid][`${day}-P${period}`]);
    }

    function occupy(tid, day, period) {
      if (!teacherSchedule[tid]) teacherSchedule[tid] = {};
      teacherSchedule[tid][`${day}-P${period}`] = true;
    }
function generateSchedule(grade) {
  const schedule = {};
  const assign = assignments[grade];
  if (!assign) return null;

  const mathsPeriodsOnly = [0, 1,  3, 4, 6, 7]; // Maths only between 8:00â€“12:55
  const allowedPeriodsFor = (subj) => subj === 'Maths' ? mathsPeriodsOnly : null;

  const doubleLessonSubjects = ['Integrated Science', 'Pre-Technical', 'Agriculture', 'Creative Arts & Sports'];
  const doubleLessonPlaced = {};
  const doubleLessonDays = new Set();
  const doubleLessonTimeGroups = {};
  const timeGroup = (p) => p <= 2 ? 'early' : p <= 5 ? 'mid' : 'late';

  const assignedSubjects = [...subjects.daily, ...subjects.fourPerWeek];
  const allSubjectsPerWeek = {};
  subjects.daily.forEach(subj => allSubjectsPerWeek[subj] = 5);
  subjects.fourPerWeek.forEach(subj => allSubjectsPerWeek[subj] = 4);

  days.forEach(day => {
    schedule[day] = Array(periods.length).fill('');
  });

  periods.forEach((label, i) => {
    if (label === 'Break' || label === 'Lunch' || label === 'Games') {
      days.forEach(day => schedule[day][i] = label);
    }
  });

  const subjectAppearsOnDay = (day, subj) =>
    schedule[day].some(cell => cell.includes(subj));

  const subjectAppearsAtPeriod = (period, subj) =>
    days.some(day => schedule[day][period]?.includes(subj));

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function findFreeSlotAvoidingPattern(tid, subj, avoid = {}, allowedPeriods = null) {
    const options = [];
    for (let day of days) {
      if (subjectAppearsOnDay(day, subj)) continue;
      for (let p of lessonSlots) {
        if (
          (!allowedPeriods || allowedPeriods.includes(p)) &&
          !schedule[day][p] &&
          isFree(tid, day, p + 1) &&
          !subjectAppearsAtPeriod(p, subj) &&
          (!avoid[day] || !avoid[day].includes(p))
        ) {
          options.push({ day, period: p });
        }
      }
    }
    return options.sort(() => Math.random() - 0.5)[0] || null;
  }

  function findDoubleFreeSlot(tid, subj) {
    doubleLessonTimeGroups[subj] ??= new Set();
    const shuffledDays = [...days];
    shuffleArray(shuffledDays);

    for (let day of shuffledDays) {
      if (doubleLessonDays.has(day)) continue;
      const periodPairs = [...Array(periods.length - 1).keys()];
      shuffleArray(periodPairs);

      for (let p of periodPairs) {
        const group = timeGroup(p);
        if (doubleLessonTimeGroups[subj].has(group)) continue;

        if (
          !schedule[day][p] &&
          !schedule[day][p + 1] &&
          !['Break', 'Lunch', 'Games'].includes(periods[p]) &&
          !['Break', 'Lunch', 'Games'].includes(periods[p + 1]) &&
          isFree(tid, day, p + 1) &&
          isFree(tid, day, p + 2)
        ) {
          doubleLessonTimeGroups[subj].add(group);
          return { day, period: p };
        }
      }
    }

    return null;
  }

  const subjectPlacedCount = {};
  assignedSubjects.forEach(s => subjectPlacedCount[s] = 0);

  // STEP 1: Place double lessons
  doubleLessonSubjects.forEach(subj => {
    const tid = assign[subj];
    const doubleSlot = findDoubleFreeSlot(tid, subj);
    if (doubleSlot) {
      const label = `${subj} (T${tid})`;
      const styledCell = `<div style="background-color: #bbdefb; padding: 4px;">${label}</div>`; // Yellow highlight

      schedule[doubleSlot.day][doubleSlot.period] = styledCell;
      schedule[doubleSlot.day][doubleSlot.period + 1] = styledCell;

      occupy(tid, doubleSlot.day, doubleSlot.period + 1);
      occupy(tid, doubleSlot.day, doubleSlot.period + 2);

      subjectPlacedCount[subj] += 2;
      doubleLessonPlaced[subj] = true;
      doubleLessonDays.add(doubleSlot.day);
    }
  });

  // STEP 2: Place regular lessons
  assignedSubjects.forEach(subj => {
    const tid = assign[subj];
    const maxCount = allSubjectsPerWeek[subj];
    const avoid = {};
    let count = subjectPlacedCount[subj];

    while (count < maxCount) {
      const slot = findFreeSlotAvoidingPattern(tid, subj, avoid, allowedPeriodsFor(subj));
      if (!slot) break;
      schedule[slot.day][slot.period] = `${subj} (T${tid})`;
      occupy(tid, slot.day, slot.period + 1);
      subjectPlacedCount[subj]++;
      count++;
      avoid[slot.day] ??= [];
      avoid[slot.day].push(slot.period);
    }
  });

  // STEP 3: Try fill blanks intelligently
  for (let day of days) {
    for (let p of lessonSlots) {
      if (!schedule[day][p]) {
        for (let subj of assignedSubjects) {
          if (subj === 'Maths' && !mathsPeriodsOnly.includes(p)) continue;
          const tid = assign[subj];
          const maxCount = allSubjectsPerWeek[subj];
          if (
            subjectPlacedCount[subj] < maxCount &&
            !subjectAppearsOnDay(day, subj) &&
            !subjectAppearsAtPeriod(p, subj) &&
            isFree(tid, day, p + 1)
          ) {
            schedule[day][p] = `${subj} (T${tid})`;
            occupy(tid, day, p + 1);
            subjectPlacedCount[subj]++;
            break;
          }
        }
      }
    }
  }

  // STEP 4: Final fill using only free periods
  for (let day of days) {
    for (let p of lessonSlots) {
      if (!schedule[day][p]) {
        for (let subj of assignedSubjects) {
          if (subj === 'Maths' && !mathsPeriodsOnly.includes(p)) continue;
          const tid = assign[subj];
          const maxCount = allSubjectsPerWeek[subj];
          if (subjectPlacedCount[subj] < maxCount && isFree(tid, day, p + 1)) {
            schedule[day][p] = `${subj} (T${tid})`;
            occupy(tid, day, p + 1);
            subjectPlacedCount[subj]++;
            break;
          }
        }
      }
    }
  }

  // STEP 5: Resolve teacher conflicts
  const teacherMap = {};
  for (let d of days) {
    for (let p of lessonSlots) {
      const cell = schedule[d][p];
      if (cell.includes('(T')) {
        const tid = parseInt(cell.split('(T')[1].replace(')', ''));
        teacherMap[d] ??= {};
        teacherMap[d][p] ??= [];
        teacherMap[d][p].push({ tid, subj: cell.split(' (')[0], grade });
      }
    }
  }

  for (let d of days) {
    for (let p of lessonSlots) {
      const entries = teacherMap[d]?.[p] || [];
      if (entries.length > 1) {
        for (let i = 1; i < entries.length; i++) {
          const { tid, subj } = entries[i];
          schedule[d][p] = '';
          subjectPlacedCount[subj]--;
          const slot = findFreeSlotAvoidingPattern(tid, subj, {}, allowedPeriodsFor(subj));
          if (slot) {
            schedule[slot.day][slot.period] = `${subj} (T${tid})`;
            occupy(tid, slot.day, slot.period + 1);
            subjectPlacedCount[subj]++;
          }
        }
      }
    }
  }

  // STEP 6: Fill any remaining gaps no matter what
  for (let day of days) {
    for (let p of lessonSlots) {
      if (!schedule[day][p]) {
        for (let subj of assignedSubjects) {
          if (subj === 'Maths' && !mathsPeriodsOnly.includes(p)) continue;
          const tid = assign[subj];
          if (isFree(tid, day, p + 1)) {
            schedule[day][p] = `${subj} (T${tid})`;
            occupy(tid, day, p + 1);
            break;
          }
        }
      }
    }
  }

  return schedule;
}



function generateCombinedTimetable() {
  const output = document.getElementById('combined-timetable');
  output.innerHTML = '';
  teacherSchedule = {};

  const selected = [...document.querySelectorAll(`#grade-selector input:checked`)].map(g => g.value);
  if (!selected.length) return showCustomAlert('Select at least one grade.', 'red');
  for (let grade of selected) {
    if (!assignments[grade]) return showCustomAlert(`No assignments for Grade ${grade}`, 'orange');
  }

  const allSchedules = {};

  selected.forEach(grade => {
    allSchedules[grade] = generateSchedule(grade);
  });
const wrapper = document.createElement('div');
wrapper.className = 'mb-8 p-4 border shadow-md rounded-2xl bg-white overflow-auto';

// ?? Define row colors per grade (will cycle through if more grades than colors)
const gradeColors = [
  '#f8f9fa', // light gray
  '#e0f7fa', // cyan
  '#f1f8e9', // light green
  '#fff3e0', // orange
  '#fce4ec', // pink
  '#ede7f6', // light purple
  '#e8f5e9', // mint
  '#fffde7', // yellow
  '#e3f2fd', // light blue
];

let html = `
  <style>
    #combined-timetable table, 
    #combined-timetable th, 
    #combined-timetable td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    #combined-timetable th, 
    #combined-timetable td {
      padding: 8px;
      text-align: center;
    }
    #combined-timetable thead {
      background-color: #f1f1f1;
      font-weight: bold;
    }
    .break-cell {
      background-color: #ffeeba;
    }
    .lunch-cell {
      background-color: #c3e6cb;
    }
    .games-cell {
      background-color: #bee5eb;
    }
  </style>

  <div class="flex justify-between items-center mb-4">
    <h3 class="text-xl font-bold text-white bg-red-600 px-4 py-2 rounded shadow-md">
      <i class="fas fa-calendar-alt mr-2"></i> Generated Master Timetable Is Here
    </h3>
  </div>

  <table class="w-full text-sm">
    <thead>
      <tr>
        <th>Day</th>
        <th>Grade</th>`;

periods.forEach(t => {
  html += `<th>${t}</th>`;
});

html += `</tr></thead><tbody>`;

// ?? Color each grade consistently using color index
const gradeColorMap = {};
let colorIndex = 0;
Object.keys(allSchedules).forEach(grade => {
  gradeColorMap[grade] = gradeColors[colorIndex % gradeColors.length];
  colorIndex++;
});

days.forEach(day => {
  Object.entries(allSchedules).forEach(([grade, schedule]) => {
    const bgColor = gradeColorMap[grade];
    html += `<tr style="background-color: ${bgColor};"><td>${day}</td><td>${grade}</td>`;
    schedule[day].forEach(subject => {
      const lower = subject.toLowerCase();
      let cellClass = '';
      if (lower.includes('break')) cellClass = 'break-cell';
      else if (lower.includes('lunch')) cellClass = 'lunch-cell';
      else if (lower.includes('games')) cellClass = 'games-cell';
      html += `<td class="${cellClass}">${subject}</td>`;
    });
    html += `</tr>`;
  });
});

html += `</tbody></table>`;
wrapper.innerHTML = html;
output.appendChild(wrapper);
}
function showCustomAlert(message, color) {
  const alertBox = document.createElement('div');
  alertBox.className = 'custom-alert';
  
  // Style the alert box
  alertBox.style.position = 'fixed';
  alertBox.style.top = '50%';
  alertBox.style.left = '50%';
  alertBox.style.transform = 'translate(-50%, -50%)';
  alertBox.style.backgroundColor = color;
  alertBox.style.color = 'white';
  alertBox.style.padding = '15px 30px';
  alertBox.style.margin = '10px 0';
  alertBox.style.borderRadius = '5px';
  alertBox.style.textAlign = 'center';
  alertBox.style.zIndex = '9999'; // Ensures it is on top of other elements
  alertBox.style.fontSize = '16px';
  alertBox.style.boxShadow = '0px 4px 8px rgba(0, 0, 0, 0.2)'; // Optional shadow for better visibility
  alertBox.innerText = message;

  // Add the alert to the body
  document.body.appendChild(alertBox);

  // Automatically remove the alert after 3 seconds
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}

function printCombinedTimetable() {
  const term = document.getElementById("term-selector")?.value || "Term 1";
  const logoURL = "https://i.imgur.com/55WxXPp.png ";

  const headerHTML = `
    <div style="text-align:center; margin-bottom: 20px;">
      <img src="${logoURL}" alt="School Logo" style="height: 80px; margin-bottom: 10px;"><br>
      <h2 style="margin: 0; font-family: Arial; color: black;">NACHU JUNIOR  SCHOOL</h2>
      <h3 style="margin: 0; font-family: Arial; color: black;">MASTER TIMETABLE 2025</h3>
      <p style="font-family: Arial; color: black;"><strong>TERM:</strong> ${term}</p>
    </div>
  `;

  const footerHTML = `
    <div style="margin-top: 30px; text-align: center; font-size: 12px; font-family: Arial; color: black;">
      <hr style="margin: 20px auto; border: none; border-top: 1px solid #000; width: 80%;">
      <strong>POWERED BY RASM TECHNOLOGIES - YOUR NUMBER ONE SCHOOL MANAGEMENT SOFTWARE</strong>
    </div>
  `;

  const timetable = document.getElementById('combined-timetable');
  const clonedTable = timetable.cloneNode(true);
  clonedTable.setAttribute("style", "width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 12pt;");

  const ths = clonedTable.querySelectorAll("th");
  ths.forEach(th => {
    th.setAttribute("style", "background-color: #4CAF50; color: black; border: 1px solid #333; padding: 6px; text-align: center;");
  });

  const tds = clonedTable.querySelectorAll("td");
  tds.forEach(td => {
    let bg = "";
    const text = td.innerText.trim().toLowerCase();
    if (text === "break") bg = "#ffeeba";
    else if (text === "lunch") bg = "#ffeeba";
    else if (text === "games") bg = "#ffeeba";

    td.setAttribute("style", `color: black; border: 1px solid #333; padding: 6px; text-align: center; font-family: Arial;${bg ? " background-color: " + bg + "; font-weight: bold;" : ""}`);
  });

  const printWindow = window.open('', '', 'height=900,width=1200');
  printWindow.document.write('<html><head><title>Print Timetable</title></head><body style="margin:0; padding:20px;">');
  printWindow.document.write(headerHTML);
  printWindow.document.write(clonedTable.outerHTML);
  printWindow.document.write(footerHTML);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}

function toggleGradeSelector() {
    const container = document.getElementById("grade-container");
    container.style.display = (container.style.display === "none") ? "block" : "none";
  }
  function login() { 
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  // Dummy validation for now (replace with real authentication logic)
  if (username === "admin" && password === "7") {
    // Hide login page and show the main content
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('single-view').style.display = 'block';

    // Populate teacher dropdown after login
    populateTeacherDropdown();
  } else {
    document.getElementById('login-error').style.display = 'block';
  }
}

 function toggleButtonGroup() {
    const group = document.getElementById('button-group');
    const toggleBtn = event.currentTarget;

    if (group.style.display === "none") {
      group.style.display = "flex";
      toggleBtn.innerHTML = '<i class="fas fa-eye-slash" style="margin-right: 8px;"></i> Hide Controls';
    } else {
      group.style.display = "none";
      toggleBtn.innerHTML = '<i class="fas fa-tools" style="margin-right: 8px;"></i> Show Controls';
    }
  }


 function toggleRegisterForm() {
    const box = document.getElementById('register-teacher-box');
    const isVisible = box.style.display === 'block';
    box.style.display = isVisible ? 'none' : 'block';
  }
let confirmCallback = null;

function showCustomConfirm(message, callback) {
  const confirmModal = document.getElementById('customConfirm');
  document.getElementById('confirmMessage').innerText = message;
  confirmModal.style.display = 'block';
  confirmCallback = callback;
}

// Attach event listeners to buttons outside the modal HTML definition
document.getElementById('confirmYes').onclick = function() {
  if (confirmCallback) {
    confirmCallback(true); // Callback is executed when 'Yes' is pressed
  }
  document.getElementById('customConfirm').style.display = 'none'; // Close modal
};

document.getElementById('confirmNo').onclick = function() {
  if (confirmCallback) {
    confirmCallback(false); // Callback is executed when 'No' is pressed
  }
  document.getElementById('customConfirm').style.display = 'none'; // Close modal
};

// ?? Function to update the teacher lists in both views
function updateTeacherLists() {
  const teacherList = document.getElementById('teacher-list');
  const wizTeacherList = document.getElementById('wiz-teacher-list');
  teacherList.innerHTML = '';
  wizTeacherList.innerHTML = '';

  teachers.forEach((t, index) => {
    const itemHTML = `
      <li>
        ${t.name} (T${t.id})
        <button onclick="deleteTeacher(${index})" style="margin-left:10px; color: red; border: none; background: transparent; cursor: pointer;">
          <i class="fas fa-trash-alt"></i>
        </button>
      </li>
    `;
    teacherList.innerHTML += itemHTML;
    wizTeacherList.innerHTML += itemHTML;
  });
}

// ?? Function to delete teacher by index with a custom prompt
function deleteTeacher(index) {
  showCustomConfirm(`Are you sure you want to delete ${teachers[index].name}?`, function(confirmed) {
    if (confirmed) {
      // Remove teacher from the teachers array
      teachers.splice(index, 1);

      // Save the updated teachers array to localStorage
      localStorage.setItem('teachers', JSON.stringify(teachers));

      // Re-render the teacher list
      updateTeacherLists();
    }
  });
}

// ?? Custom confirm function with colored alert
function showCustomConfirm(message, callback) {
  const confirmBox = document.createElement('div');
  confirmBox.className = 'custom-confirm';

  // Style the confirmation box
  confirmBox.style.position = 'fixed';
  confirmBox.style.top = '50%';
  confirmBox.style.left = '50%';
  confirmBox.style.transform = 'translate(-50%, -50%)';
  confirmBox.style.backgroundColor = '#f8d7da';
  confirmBox.style.color = '#721c24';
  confirmBox.style.padding = '20px 40px';
  confirmBox.style.borderRadius = '10px';
  confirmBox.style.textAlign = 'center';
  confirmBox.style.zIndex = '9999';
  confirmBox.style.fontSize = '16px';
  confirmBox.style.boxShadow = '0px 4px 8px rgba(0, 0, 0, 0.2)';
  
  confirmBox.innerHTML = `
    <p>${message}</p>
    <button id="confirm-yes" style="margin-right: 10px; padding: 5px 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Yes</button>
    <button id="confirm-no" style="padding: 5px 15px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">No</button>
  `;

  // Append confirm box to body
  document.body.appendChild(confirmBox);

  // Add event listeners for buttons
  document.getElementById('confirm-yes').onclick = function() {
    callback(true);  // User confirmed
    confirmBox.remove();  // Remove the confirm box
  };

  document.getElementById('confirm-no').onclick = function() {
    callback(false);  // User canceled
    confirmBox.remove();  // Remove the confirm box
  };
}


function logout() {
  // Show the login section again
  document.getElementById('login-page').style.display = 'block';

  // Hide the main view
  document.getElementById('single-view').style.display = 'none';

  // Optionally clear login fields
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';

  // Show success alert
  showCustomAlert('You have successfully logged out.', 'green');  // Green alert for success
}
function showCustomAlert(message, color) {
  const alertBox = document.createElement('div');
  alertBox.className = 'custom-alert';
  
  // Style the alert box
  alertBox.style.position = 'fixed';
  alertBox.style.top = '50%';
  alertBox.style.left = '50%';
  alertBox.style.transform = 'translate(-50%, -50%)';
  alertBox.style.backgroundColor = color;
  alertBox.style.color = 'white';
  alertBox.style.padding = '15px 30px';
  alertBox.style.margin = '10px 0';
  alertBox.style.borderRadius = '5px';
  alertBox.style.textAlign = 'center';
  alertBox.style.zIndex = '9999'; // Ensures it is on top of other elements
  alertBox.style.fontSize = '16px';
  alertBox.style.boxShadow = '0px 4px 8px rgba(0, 0, 0, 0.2)'; // Optional shadow for better visibility
  alertBox.innerText = message;

  // Add the alert to the body
  document.body.appendChild(alertBox);

  // Automatically remove the alert after 3 seconds
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}



function extractFromCombinedTimetable() {
  const combined = document.querySelector("#combined-timetable table");
  if (!combined) {
    return showAlert("Combined timetable not found!", "error");
  }

  const rows = Array.from(combined.querySelectorAll("tbody tr"));
  const header = Array.from(combined.querySelectorAll("thead th")).slice(2); // Time periods
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];

  const classTimetables = {};
  const teacherTimetables = {};

  for (let row of rows) {
    const cells = Array.from(row.querySelectorAll("td"));
    const day = cells[0].innerText.trim();
    const grade = cells[1].innerText.trim();

    if (!classTimetables[grade]) {
      classTimetables[grade] = {};
      days.forEach(d => classTimetables[grade][d] = new Array(header.length).fill(""));
    }

    for (let i = 2; i < cells.length; i++) {
      const subjectText = cells[i].innerText.trim();
      classTimetables[grade][day][i - 2] = subjectText;

      const match = subjectText.match(/\(T(\d+)\)/);
      if (match) {
        const tid = "T" + match[1];
        if (!teacherTimetables[tid]) {
          teacherTimetables[tid] = {};
          days.forEach(d => teacherTimetables[tid][d] = new Array(header.length).fill(""));
        }
        teacherTimetables[tid][day][i - 2] = `${subjectText.split(" (")[0]} (${grade})`;
      }
    }
  }

  // Render the results
  const output = document.getElementById("extracted-timetables");
  output.innerHTML = "";

  // Class Timetables
  for (let grade in classTimetables) {
    let html = `<h3 style="color:#1a237e; margin-top:30px;">Class Timetable - ${grade}</h3>`;
    html += buildTable(classTimetables[grade], header);

    output.innerHTML += `
      <div class="extracted-block" style="margin-bottom: 40px;">
        ${html}
        <button onclick="printThisTimetable(this)" style="margin-top: 10px; background-color: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
          <i class="fas fa-print"></i> Print This Timetable
        </button>
      </div>`;
  }

  // Teacher Timetables
  for (let tid in teacherTimetables) {
    let html = `<h3 style="color:#2e7d32; margin-top:30px;">Teacher Timetable - ${tid}</h3>`;
    html += buildTable(teacherTimetables[tid], header);

    output.innerHTML += `
      <div class="extracted-block" style="margin-bottom: 40px;">
        ${html}
        <button onclick="printThisTimetable(this)" style="margin-top: 10px; background-color: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
          <i class="fas fa-print"></i> Print This Timetable
        </button>
      </div>`;
  }
}
function showAlert(message, type = "error") {
  const alertBox = document.createElement("div");

  // Icon class & colors
  let iconClass = "fa-circle-exclamation";
  let bgColor = "#d32f2f";
  let borderColor = "#b71c1c";

  if (type === "success") {
    iconClass = "fa-circle-check";
    bgColor = "#4CAF50";
    borderColor = "#388E3C";
  } else if (type === "warning") {
    iconClass = "fa-triangle-exclamation";
    bgColor = "#FF9800";
    borderColor = "#EF6C00";
  }

  alertBox.innerHTML = `
    <i class="fas ${iconClass}" style="margin-right: 10px;"></i>${message}
  `;

  // Styling
  alertBox.style.position = "fixed";
  alertBox.style.top = "50%";
  alertBox.style.left = "50%";
  alertBox.style.transform = "translate(-50%, -50%)";
  alertBox.style.padding = "16px 30px";
  alertBox.style.margin = "0";
  alertBox.style.borderRadius = "10px";
  alertBox.style.fontSize = "16px";
  alertBox.style.fontWeight = "bold";
  alertBox.style.textAlign = "center";
  alertBox.style.zIndex = "9999";
  alertBox.style.backgroundColor = bgColor;
  alertBox.style.color = "white";
  alertBox.style.border = `2px solid ${borderColor}`;
  alertBox.style.boxShadow = "0px 4px 12px rgba(0, 0, 0, 0.3)";
  alertBox.style.opacity = "0";
  alertBox.style.transition = "opacity 0.5s ease";

  document.body.appendChild(alertBox);

  // Fade in
  setTimeout(() => {
    alertBox.style.opacity = "1";
  }, 10);

  // Fade out and remove
  setTimeout(() => {
    alertBox.style.opacity = "0";
    setTimeout(() => {
      alertBox.remove();
    }, 500);
  }, 3000);
}


function buildTable(schedule, headers) {
  let html = `<div style="overflow-x:auto;"><table style="border-collapse: collapse; width: 100%; font-size: 12px;"><thead><tr><th style="border: 1px solid #000; padding: 6px;">Day</th>`;
  headers.forEach(h => {
    html += `<th style="border: 1px solid #000; padding: 6px;">${h.innerText}</th>`;
  });
  html += '</tr></thead><tbody>';

  for (let day in schedule) {
    html += `<tr><td style="border: 1px solid #000; padding: 6px;">${day}</td>`;
    schedule[day].forEach(period => {
      html += `<td style="border: 1px solid #000; padding: 6px; text-align: center;">${period || ''}</td>`;
    });
    html += '</tr>';
  }

  html += '</tbody></table></div>';
  return html;
}
function printThisTimetable(button) {
  const timetableBlock = button.closest(".extracted-block").cloneNode(true);
  timetableBlock.querySelector("button").remove();

  const logoURL = " https://i.imgur.com/55WxXPp.png";
  const headerText = timetableBlock.querySelector("h3")?.innerText || "Timetable";
  const isClass = headerText.toLowerCase().includes("class timetable");

  const headerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="${logoURL}" style="height: 80px; margin-bottom: 10px;"><br>
      <h2 style="margin: 0; font-size: 24px; font-family: Arial; font-weight: bold; color: black;">NACHU JUNIOR  SCHOOL</h2>
      <h3 style="margin: 0; font-size: 18px; font-family: Arial; font-weight: bold; color: black;">${headerText}</h3>
    </div>
  `;

  const footerHTML = `
    <div style="margin-top: 30px; text-align: center; font-size: 12px; font-family: Arial; color: black;">
      <hr style="margin: 20px auto; border: none; border-top: 1px solid #000; width: 80%;">
      <strong>POWERED BY RASM TECHNOLOGIES - YOUR NUMBER ONE SCHOOL MANAGEMENT SOFTWARE</strong>
    </div>
  `;

  // Enhance table styling
  const table = timetableBlock.querySelector("table");
  table.style.width = "100%";
  table.style.borderCollapse = "collapse";
  table.style.fontFamily = "Arial, sans-serif";
  table.style.fontSize = "12pt";
  table.style.tableLayout = "fixed";
  table.style.wordWrap = "break-word";
  table.style.overflowWrap = "break-word";
  table.style.color = "black";

  table.querySelectorAll("th").forEach(th => {
    th.style.border = "2px solid black";
    th.style.padding = "8px";
    th.style.fontWeight = "bold";
    th.style.backgroundColor = "#f1f1f1";
    th.style.textAlign = "center";
    th.style.color = "black";
  });

  table.querySelectorAll("td").forEach(td => {
    td.style.border = "2px solid black";
    td.style.padding = "8px";
    td.style.textAlign = "center";
    td.style.wordWrap = "break-word";
    td.style.overflowWrap = "break-word";
    td.style.color = "black";
  });

  const printCSS = `
    <style>
      @page {
        size: A4 landscape;
        margin: 0.5cm;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        color: black;
      }
      table {
        width: 100%;
        table-layout: fixed;
        color: black;
      }
      th, td {
        word-wrap: break-word;
        overflow-wrap: break-word;
        color: black;
      }
      ${isClass ? `
        .print-block {
          page-break-inside: avoid;
          transform: scale(0.98);
          transform-origin: top left;
        }
      ` : ''}
    </style>
  `;

  const printWindow = window.open('', '', 'width=1000,height=800');
  printWindow.document.write(`<html><head><title>Print Timetable</title>${printCSS}</head><body>`);
  printWindow.document.write(`<div class="print-block">${headerHTML}${timetableBlock.innerHTML}${footerHTML}</div>`);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}

</script>
 
</body>
</html>
